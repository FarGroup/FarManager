<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<title>Как уменьшить размер плагина: Borland C++ 5.02</title>
<meta http-equiv="Content-Type" Content="text/html; charset=Windows-1251">
<LINK REV=made href="mailto:vskirdin@mail.ru">
<META NAME="Author"   content="Valentin Skirdin">
<META NAME="description" CONTENT="How to reduce size plugin. On example of compiler Borland C++ 5.02">
<link rel="stylesheet" type="text/css" href="../../styles/styles.css">
<script language="JavaScript" src='../links.js' type="text/javascript"></script>
</HEAD>

<Body>

<a name="top"></a>
<h1>Как уменьшить размер плагина</h1>
<h5>(на примере Borland C++ 5.02)</h1>
<div class=navbar>
<a href="../index.html">главная</a> |
<a href="index.html">статьи</a>
</div>

<div align=right>
<code>Валентин Скирдин <a href="mailto:Valentin%20Skirdin%20<vskirdin@mail.ru>?subject=Articles">
<img src="../../images/email.gif" border="0" alt="[vskirdin@mail.ru]" width="16" height="16" align="middle">vskirdin@mail.ru</a>
</code></div>
<hr color="#003399">

<p class=plain>Основная часть моей сознательной программистской жизни была
связана с компиляторами от фирмы <b>Borland</b>: сначала TurboC
2.5, потом Borland C++ 3.1, сейчас это Borland C++ 5.02. Именно как
я стремился уменьшить размер плагина "<a target="_blank" href="http://plugring.farmanager.com/cgi-bin/downld.cgi?Draw=List&Select=PlugIn&SelectPlugIn=28">EditSwap</a>"
сейчас и опишу...</p>

<p class=plain>По началу все как обычно - создаем проект (DLL, Win32 Console, Dinamic),
генерим MAK-файл и с этим MAK-файлом и работаем... Можно конечно и из среды все это
дело скомпилить, но то, о чем я Вам сейчас расскажу, такого сделать в IDE не
получится...</p>

<p class=plain>...После компиляции размер DLL`я получился примерно 8K.
Попробовал - заработало. Написал письмо <a href="mailto:Eugene Roshal <roshal@rarsoft.com>">Рошалу</a>
&quot;о своих достижениях&quot; и приатачил к письму архив со своим
&quot;творением&quot;... Вот что я получил в ответ:</p>

<dir>
<i>Ты его похоже слинковал с dynamic libraries, так
что при отсутствии cw3230.dll он не грузится. В
принципе можешь закачать его на <a
href="ftp://rwntug.quarta.msk.ru">ftp://rwntug.quarta.msk.ru</a>. Правда там
уже лежит аналогичный - qwerty.rar, но он тоже
слинкован с dynamic libraries и соответственно почти ни у
кого не запускается :-)</i>
</dir>

<p class=plain>...Скомпилил без <em>dynamic libraries</em> - увы, размер
DLL`лины увеличился раз в семь <code>:-(</code>. Странно - оригинальный
<b>EditCase</b> после компиляции получался либо таким же монстром либо
требовал <code><i>cw3230.dll</i></code>... У Рошала выяснил, что...</p>

<dir>
    <em>Генерируешь makefile, а потом <u>убираешь из
    него startup code</u>: это строка с c0d32.obj. Правда после
    этого некоторые функции сишной библиотеки
    становятся недоступными (например,
    распределение памяти), и приходится напрямую
    обращаться к Win32 API. </em>
</dir>

<p class=plain>Пробую - не получается - линковщик выдает ошибки - чой-то найти
не смог... Оказалось, что вместо TLINK стоял ILINK. Заменил ILINK на TLINK и...
опять строка <code><i>cw3230.dll</i></code> присутствует в файле... </p>

<p class=plain>...Последняя правка MAK-файла привела к желаемому результату -
компактно и не требует дополнительных DLL-файлов. Вот то, что у меня получилось:</p>

<pre class=code># Borland C++ IDE generated makefile
#
.AUTODEPEND

#
# Borland C++ tools
#
IMPLIB  = Implib
BCC32   = Bcc32 +BccW32.cfg
TLINK32 = TLink32
TLIB    = TLib

#
# Dependency List
#
Dep_EditSwap = editswap.lib

EditSwap : BccW32.cfg $(Dep_EditSwap)
  echo MakeNode

editswap.lib : editswap.dll
  $(IMPLIB) $@ editswap.dll

Dep_editswapddll = editswap.obj

editswap.dll : $(Dep_editswapddll)
  $(<font
color="#FF0000">TLINK32</font>) @&amp;&amp;|
# <em>Если здесь ставить  ILINK32 - то без c0d32.obj ну ни как...</em>
  -Tpd -ap -c -w-dll -LU:\BC5\LIB -x +
# <font
color="#FF0000"><strike>c:\bc5\lib\c0d32.obj</strike></font><em> - если эту строку оставить, то размерчик...</em>
editswap.obj
$&lt;,$*
C:\BC5\LIB\import32.lib+
<font color="#FF0000">C:\BC5\LIB\cw32.lib</font>
# C:\BC5\LIB\cw32i.lib <em>- эта строка приводила к cw3230.dll</em>

|
editswap.obj :  editswap.cpp
  $(BCC32) -c @&amp;&amp;|
  -o$@ editswap.cpp
|

# Compiler configuration file
BccW32.cfg :
   Copy &amp;&amp;|
-w
-v-
...
-a1
-IC:\BC5\INCLUDE
| $@
</pre>

<p class=plain>Вот, собственно и все. Шаманство да и только <code>:-)</code></p>

<p class=plain>Хотя, скажу по секрету, все равно получаются монстры.
И это, естественно, зависит от набора используемых функций...</p>

<br>&nbsp;<br>
<p class=plain><b>P.S.</b><br>
Однажды, 30 Jun 1999, Владимир Тарасов (<a href="mailto:tsoftgroup@chat.ru">tsoftgroup@chat.ru</a>)
написал, что не использует MAK-файлы для построения плагинов:<br>
<em>ну вобщем, я использовал ручной метод сборки, т.е. у меня bat-ник такого содержания:</em>
</p>

<pre class=code>@echo off
del qwerty.dll
del qwerty.lib
del qwerty.obj
bcc32 -c -M- qwerty.cpp
tlib qwerty.lib +qwerty.obj
tlink32 -Tpd -aa qwerty.obj, qwerty.dll, , import32 cw32
</pre>

<p class=plain>
...вот этим я сейчас и пользуюсь. Иногда приходится некоторые функции выдирать из
стандартной библиотеки и, перелопатив их, "подсовывать" компилятору, но это уже
совсем другая история.
</p>

<div align=right><code>
<br>&nbsp;<br>
31.05.1999
</code></div>
<div class=seecont><a href="#top">наверх</a></div>

</body>
</html>