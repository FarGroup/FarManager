#The following variables can be set by the user:
#
#DEBUG - set if a debug build is needed
#
#LINK_ULINK - set if you want to use ulink for linking
#
#USE_VC9 - set if you want to compile with VC 2008 (we try to autodetect if not set)
#
#USE_VC8_32 - set if you want to compile with VC 2005 (we try to autodetect if not set)
#
#AMD64 - set for x64 build
#  or
#CPU=AMD64 - for x64 build
#
#IA64 - set for IA64 build
#  or
#CPU=IA64 - for IA64 build
#
#FARSYSLOG - for syslog
#
#DISABLE_WOW64_HOOK - set to disable the wow64 hook
#
#DEFFILE - name of user file to include
#
#EXCEPTION_TEST - set to generate Ctrl-Alt-Apps dialog in release
#

#include for user defines if needed
!if defined(DEFFILE)
!include $(DEFFILE)
!endif

!if defined(AMD64) || "$(CPU)" == "AMD64"
!undef AMD64
!undef CPU
AMD64=1
CPU=AMD64
DIRBIT = 64
_BUILD64=1
!elseif defined(IA64) || "$(CPU)" == "IA64"
!undef IA64
!undef CPU
IA64=1
CPU=IA64
DIRBIT = IA64
_BUILD64=1
!else
DIRBIT=32
_BUILD64=0
!endif

!IF "$(OS)" == "Windows_NT"
NULL=
!ELSE
NULL=nul
!ENDIF

!ifndef DEBUG
DIRNAME=Release
USEDEBUG=NDEBUG
!else
DIRNAME=Debug
USEDEBUG=_DEBUG
!endif                   

DEPFILE=far.vc.dep

OUTDIR=$(DIRNAME).$(DIRBIT).vc

FARINCLUDE=Include

CPP=cl.exe
RSC=rc.exe /D__FARBIT__=$(DIRBIT)
LINK32=link.exe
ULINK=ulink.exe
M4=tools\m4 -P -DFARBIT=$(DIRBIT)
GAWK=tools\gawk

!if $(_BUILD64)
ML=ml64.exe
!else
ML=ml.exe
!endif

!ifdef FARSYSLOG
INTDIR=$(OUTDIR)\objlog
!else
INTDIR=$(OUTDIR)\obj
!endif
CODDIR=$(OUTDIR)\cod

DEF_FILE = ".\far.def"

RES_FILE = "$(INTDIR)\far.res"

PCH_FILES = "$(INTDIR)\headers.c.pch" \
            "$(INTDIR)\headers.cpp.pch"

LINK32_OBJS= \
!if !$(_BUILD64) && !defined(DISABLE_WOW64_HOOK)
	"$(INTDIR)\hook_wow64.obj" \
!endif
	"$(INTDIR)\cddrv.obj" \
	"$(INTDIR)\CFileMask.obj" \
	"$(INTDIR)\chgmmode.obj" \
	"$(INTDIR)\chgprior.obj" \
	"$(INTDIR)\clipboard.obj" \
	"$(INTDIR)\cmdline.obj" \
	"$(INTDIR)\cmem.obj" \
	"$(INTDIR)\config.obj" \
	"$(INTDIR)\constitle.obj" \
	"$(INTDIR)\copy.obj" \
	"$(INTDIR)\ctrlobj.obj" \
	"$(INTDIR)\cvtname.obj" \
	"$(INTDIR)\del.obj" \
	"$(INTDIR)\delete.obj" \
	"$(INTDIR)\dialog.obj" \
	"$(INTDIR)\dizlist.obj" \
	"$(INTDIR)\dlgedit.obj" \
	"$(INTDIR)\edit.obj" \
	"$(INTDIR)\editor.obj" \
	"$(INTDIR)\eject.obj" \
	"$(INTDIR)\hotplug.obj" \
	"$(INTDIR)\execute.obj" \
	"$(INTDIR)\farexcpt.obj" \
	"$(INTDIR)\farqueue.obj" \
	"$(INTDIR)\farrtl.obj" \
	"$(INTDIR)\farwinapi.obj" \
	"$(INTDIR)\ffolders.obj" \
	"$(INTDIR)\fileattr.obj" \
	"$(INTDIR)\fileedit.obj" \
	"$(INTDIR)\filefilter.obj" \
	"$(INTDIR)\filefilterparams.obj" \
	"$(INTDIR)\filelist.obj" \
	"$(INTDIR)\FileMasksProcessor.obj" \
	"$(INTDIR)\FileMasksWithExclude.obj" \
	"$(INTDIR)\fileowner.obj" \
	"$(INTDIR)\filepanels.obj" \
	"$(INTDIR)\filestr.obj" \
	"$(INTDIR)\filetype.obj" \
	"$(INTDIR)\fileview.obj" \
	"$(INTDIR)\findfile.obj" \
	"$(INTDIR)\flink.obj" \
	"$(INTDIR)\flmodes.obj" \
	"$(INTDIR)\flplugin.obj" \
	"$(INTDIR)\flshow.obj" \
	"$(INTDIR)\flupdate.obj" \
	"$(INTDIR)\fnparce.obj" \
	"$(INTDIR)\foldtree.obj" \
	"$(INTDIR)\frame.obj" \
	"$(INTDIR)\gettable.obj" \
	"$(INTDIR)\global.obj" \
	"$(INTDIR)\grabber.obj" \
	"$(INTDIR)\headers.c.obj" \
	"$(INTDIR)\headers.cpp.obj" \
	"$(INTDIR)\help.obj" \
	"$(INTDIR)\hilight.obj" \
	"$(INTDIR)\history.obj" \
	"$(INTDIR)\hmenu.obj" \
	"$(INTDIR)\infolist.obj" \
	"$(INTDIR)\interf.obj" \
	"$(INTDIR)\iswind.obj" \
	"$(INTDIR)\keybar.obj" \
	"$(INTDIR)\keyboard.obj" \
	"$(INTDIR)\language.obj" \
	"$(INTDIR)\local.obj" \
	"$(INTDIR)\lockscrn.obj" \
	"$(INTDIR)\macro.obj" \
	"$(INTDIR)\main.obj" \
	"$(INTDIR)\manager.obj" \
	"$(INTDIR)\menubar.obj" \
	"$(INTDIR)\message.obj" \
	"$(INTDIR)\mix.obj" \
	"$(INTDIR)\mkdir.obj" \
	"$(INTDIR)\mktemp.obj" \
	"$(INTDIR)\modal.obj" \
	"$(INTDIR)\namelist.obj" \
	"$(INTDIR)\new.obj" \
	"$(INTDIR)\options.obj" \
	"$(INTDIR)\palette.obj" \
	"$(INTDIR)\panel.obj" \
	"$(INTDIR)\plist.obj" \
	"$(INTDIR)\plognmn.obj" \
	"$(INTDIR)\plugapi.obj" \
	"$(INTDIR)\plugins.obj" \
	"$(INTDIR)\poscache.obj" \
	"$(INTDIR)\print.obj" \
	"$(INTDIR)\qsortex.obj" \
	"$(INTDIR)\qsort.obj" \
	"$(INTDIR)\qview.obj" \
	"$(INTDIR)\rdrwdsk.obj" \
	"$(INTDIR)\RefreshFrameManager.obj" \
	"$(INTDIR)\registry.obj" \
	"$(INTDIR)\savefpos.obj" \
	"$(INTDIR)\savescr.obj" \
	"$(INTDIR)\scantree.obj" \
	"$(INTDIR)\scrbuf.obj" \
	"$(INTDIR)\scrobj.obj" \
	"$(INTDIR)\scrsaver.obj" \
	"$(INTDIR)\setattr.obj" \
	"$(INTDIR)\setcolor.obj" \
	"$(INTDIR)\stddlg.obj" \
	"$(INTDIR)\strdup.obj" \
	"$(INTDIR)\strftime.obj" \
	"$(INTDIR)\strmix.obj" \
	"$(INTDIR)\timefunc.obj" \
	"$(INTDIR)\strncat.obj" \
	"$(INTDIR)\strncpy.obj" \
	"$(INTDIR)\syntax.obj" \
	"$(INTDIR)\tvar.obj" \
	"$(INTDIR)\TPreRedrawFunc.obj" \
	"$(INTDIR)\syslog.obj" \
	"$(INTDIR)\TaskBar.obj" \
	"$(INTDIR)\treelist.obj" \
	"$(INTDIR)\udlist.obj" \
	"$(INTDIR)\usermenu.obj" \
	"$(INTDIR)\viewer.obj" \
	"$(INTDIR)\vmenu.obj" \
	"$(INTDIR)\xlat.obj"

!if defined(_NMAKE_VER) && !defined(USE_VC9) && !defined(USE_VC8_32)
!if "$(_NMAKE_VER)">"9" || "$(_NMAKE_VER)">"10"
USE_VC9=1
!elseif "$(_NMAKE_VER)">"8"
USE_VC8_32=1
!endif
!endif

!ifndef USE_VC9
COMPAT64=/Wp64
NOWIN98=/OPT:NOWIN98
!else
!undef USE_VC8_32
USE_VC8_32=1
!endif

!ifndef USE_VC8_32
CPP_ADD_32=/Gi
!else
CPP_ADD_32=/GS- /GR-
!endif

LINK32_LIBS=kernel32.lib user32.lib winspool.lib advapi32.lib shell32.lib mpr.lib ole32.lib

RSC_PROJ=/l 0x409 /fo"$(RES_FILE)" /d $(USEDEBUG)

ULINK_MODES=-q -m- -ap -Gz -O- -o- -Gh -Gh-

DEFINES=\
	/D "USE_WFUNC"\
	/D "USE_WFUNC_ALW"\
	/D "USE_WFUNC_IN"\
	/D $(USEDEBUG)\
!if defined(DEBUG) || defined(EXCEPTION_TEST)
	/D "FAR_ALPHA_VERSION"\
!endif
!ifdef DEBUG
	/D "SYSLOG_FARSYSLOG"\
	/D "SYSLOG"\
!endif
	/D "WIN32"\
	/D "_CONSOLE"\
	/D "_CRT_SECURE_NO_DEPRECATE"\
	/D "_CRT_NONSTDC_NO_DEPRECATE"\
	/D "_CRT_NON_CONFORMING_SWPRINTFS"

CPP_PROJ_COMMON=$(MP) $(COMPAT64) /W3 /nologo $(FARSYSLOG) /EHs-c- $(DEFINES) /Gy /GF /Fo"$(INTDIR)\\" /Fd"$(INTDIR)\\" /J /c /FAcs /Fa"$(CODDIR)\\"
CPP_PROJ_RELEASE=/MT /O2 /Oy-
CPP_PROJ_DEBUG=/MTd /Od /Zi

LINK_COMMON=$(LINK32_LIBS) /OPT:REF /OPT:ICF $(NOWIN98) /nologo /subsystem:console /def:"$(DEF_FILE)" /out:"$(OUTDIR)\Far.exe" /map:"$(OUTDIR)\far.map" /pdb:"$(OUTDIR)\far.pdb" /release /nxcompat

!if "$(OUTDIR)" == "Release.32.vc"

USEDEBUG=NDEBUG

CPP_PROJ=$(CPP_PROJ_COMMON) $(CPP_PROJ_RELEASE) $(CPP_ADD_32) /Zp4
LINK32_FLAGS=$(LINK_COMMON) /incremental:no /machine:i386 /fixed:no

!elseif "$(OUTDIR)" == "Release.64.vc"

USEDEBUG=NDEBUG

CPP_PROJ=$(CPP_PROJ_COMMON) $(CPP_PROJ_RELEASE) /GS- /GR- /Zp8
LINK32_FLAGS=$(LINK_COMMON) /incremental:no /machine:amd64
ULINK_FLAGS=-Tpe+

!elseif "$(OUTDIR)" == "Release.IA64.vc"

USEDEBUG=NDEBUG

CPP_PROJ=$(CPP_PROJ_COMMON) $(CPP_PROJ_RELEASE) /GS- /GR- /Zp8
LINK32_FLAGS=$(LINK_COMMON) /incremental:no /machine:IA64

!elseif "$(OUTDIR)" == "Debug.64.vc"

USEDEBUG=_DEBUG

CPP_PROJ=$(CPP_PROJ_COMMON) $(CPP_PROJ_DEBUG) /GS- /GR-
LINK32_FLAGS=$(LINK_COMMON) /debug /machine:amd64
ULINK_FLAGS=-Tpe+ -v

!elseif "$(OUTDIR)" == "Debug.IA64.vc"

USEDEBUG=_DEBUG

CPP_PROJ=$(CPP_PROJ_COMMON) $(CPP_PROJ_DEBUG) /GS- /GR-
LINK32_FLAGS=$(LINK_COMMON) /debug /machine:IA64

!else

USEDEBUG=_DEBUG

CPP_PROJ=$(CPP_PROJ_COMMON) $(CPP_PROJ_DEBUG) $(CPP_ADD_32)
LINK32_FLAGS=$(LINK_COMMON) /debug /machine:I386 /fixed:no
ULINK_FLAGS=-v

!endif

ALL: AllDirs lng depfile
	@$(MAKE) /f makefile_vc build USEDEPS=1

.PHONY: lng
lng: farlang.templ
	@echo generating language files
	@tools\lng.generator.exe -nc -i lang.ini -ol "$(OUTDIR)" farlang.templ

.PHONY: depfile
depfile:
	@$(GAWK) -f .\scripts\mkdep.awk mkdep.list > $(DEPFILE)

.PHONY: build
build: "$(OUTDIR)\Far.exe" "$(OUTDIR)\FarEng.hlf" "$(OUTDIR)\FarRus.hlf" "$(OUTDIR)\File_id.diz" "$(FARINCLUDE)\plugin.pas" "$(FARINCLUDE)\farcolor.pas" "$(FARINCLUDE)\farkeys.pas" "$(FARINCLUDE)\farcolor.hpp" "$(FARINCLUDE)\farkeys.hpp" "$(FARINCLUDE)\plugin.hpp"

.PHONY: AllDirs
AllDirs:
	@if not exist "$(OUTDIR)\$(NULL)" mkdir "$(OUTDIR)"
	@if not exist "$(FARINCLUDE)\$(NULL)" mkdir "$(FARINCLUDE)"
	@if not exist "$(INTDIR)\$(NULL)" mkdir "$(INTDIR)"
	@if not exist "$(CODDIR)\$(NULL)" mkdir "$(CODDIR)"

"$(OUTDIR)\Far.exe": $(DEF_FILE) $(PCH_FILES) $(LINK32_OBJS) $(RES_FILE) Far.exe.manifest far.rc copyright.inc farversion.inc
	@echo linking $@
!ifndef LINK_ULINK
	@$(LINK32) @<<
	$(LINK32_FLAGS) $(LINK32_OBJS) $(RES_FILE)
<<
!else
        @$(ULINK) +- @+<<
        $(ULINK_MODES) $(ULINK_FLAGS) $(LINK32_OBJS)
        ,"$(OUTDIR)\Far.exe","$(OUTDIR)\Far.map"
        ,$(LINK32_LIBS)
        ,"$(DEF_FILE)","$(RES_FILE)"
<<
!endif

"$(INTDIR)\headers.c.pch": headers.c.c
	@echo making precompiled headers for C
	@$(CPP) $(CPP_PROJ) headers.c.c /Yc /Fp"$(INTDIR)\headers.c.pch"

"$(INTDIR)\headers.cpp.pch": headers.cpp.cpp
	@echo making precompiled headers for C++
	@$(CPP) $(CPP_PROJ) headers.cpp.cpp /Yc /Fp"$(INTDIR)\headers.cpp.pch"

.c{$(INTDIR)}.obj::
	@$(CPP) @<<
	$(CPP_PROJ) /Yuheaders.hpp /Fp"$(INTDIR)\headers.c.pch" $<
<<

.cpp{$(INTDIR)}.obj::
	@$(CPP) @<<
	$(CPP_PROJ) /Yuheaders.hpp /Fp"$(INTDIR)\headers.cpp.pch" $<
<<


.asm{$(INTDIR)}.obj:
!if $(_BUILD64)
	@$(ML) /c /Fo$@ $<
!else
	@$(ML) /c /coff /Fo$@ $<
!endif

$(RES_FILE): far.rc res.hpp Far.ico
	@echo compiling resource file
	@$(RSC) $(RSC_PROJ) far.rc

!ifdef USEDEPS
!include "$(DEPFILE)"
!endif

copyright.inc: copyright.inc.m4 farversion.m4 tools.m4 vbuild.m4
	@echo generating $@
	@$(M4) copyright.inc.m4 | $(GAWK) -f .\scripts\enc.awk > $@

farversion.inc: farversion.inc.m4 farversion.m4 tools.m4 vbuild.m4
	@echo generating $@
	@$(M4) farversion.inc.m4 > $@

Far.exe.manifest: Far.exe.manifest.m4 farversion.m4 tools.m4 vbuild.m4
	@echo generating $@
	@$(M4) Far.exe.manifest.m4 > $@

far.rc: far.rc.m4 farversion.m4 tools.m4 vbuild.m4 Far.exe.manifest res.hpp
	@echo generating $@
	@$(M4) far.rc.m4 > $@

farlang.templ: farlang.templ.m4 farversion.m4 tools.m4 vbuild.m4
	@echo generating $@
	@$(M4) farlang.templ.m4 > $@

$(FARINCLUDE)\farcolor.hpp: colors.hpp farversion.m4 tools.m4 vbuild.m4
	@echo generating $@
	@$(M4) -DINPUT=colors.hpp headers.m4 > $@

$(FARINCLUDE)\farkeys.hpp: keys.hpp farversion.m4 tools.m4 vbuild.m4
	@echo generating $@
	@$(M4) -DINPUT=keys.hpp headers.m4 > $@

$(FARINCLUDE)\plugin.hpp: plugin.hpp farversion.m4 tools.m4 vbuild.m4
	@echo generating $@
	@$(M4) -DINPUT=plugin.hpp headers.m4 > $@

$(OUTDIR)\FarEng.hlf: FarEng.hlf.m4 farversion.m4 tools.m4 vbuild.m4
	@echo generating $@
	@$(GAWK) -f .\scripts\mkhlf.awk FarEng.hlf.m4 | $(M4) > $@

$(OUTDIR)\FarRus.hlf: FarRus.hlf.m4 farversion.m4 tools.m4 vbuild.m4
	@echo generating $@
	@$(GAWK) -f .\scripts\mkhlf.awk FarRus.hlf.m4 | $(M4) > $@

$(OUTDIR)\File_id.diz: File_id.diz.m4 farversion.m4 tools.m4 vbuild.m4
	@echo generating $@
	@$(M4) File_id.diz.m4 > $@

$(FARINCLUDE)\plugin.pas: plugin.pas farversion.m4 tools.m4 vbuild.m4
	@echo generating $@
	@$(M4) -DINPUT=plugin.pas headers.m4 > $@

$(FARINCLUDE)\farcolor.pas: farcolor.pas farversion.m4 tools.m4 vbuild.m4
	@echo generating $@
	@$(M4) -DINPUT=farcolor.pas headers.m4 > $@

$(FARINCLUDE)\farkeys.pas: farkeys.pas farversion.m4 tools.m4 vbuild.m4
	@echo generating $@
	@$(M4) -DINPUT=farkeys.pas headers.m4 > $@


.PHONY: CLEAN
CLEAN:
	@echo cleaning
	-@del /q /f "$(INTDIR)\*.*"          > nul 2> nul
	-@del /q /f "$(CODDIR)\*.*"          > nul 2> nul
	-@del /q /f "lang.ini"               > nul 2> nul
	-@del /q /f "lang.hpp"               > nul 2> nul
	-@del /q /f "farlang.templ"          > nul 2> nul
	-@del /q /f "copyright.inc"          > nul 2> nul
	-@del /q /f "farversion.inc"         > nul 2> nul
	-@del /q /f "far.rc"                 > nul 2> nul
	-@del /q /f "Far.exe.manifest"       > nul 2> nul
	-@del /q /f "$(DEPFILE)"             > nul 2> nul
	-@del /q /f "$(OUTDIR)\Far.exe"      > nul 2> nul
	-@del /q /f "$(OUTDIR)\Far.exp"      > nul 2> nul
	-@del /q /f "$(OUTDIR)\Far.lib"      > nul 2> nul
	-@del /q /f "$(OUTDIR)\Far.map"      > nul 2> nul
	-@del /q /f "$(OUTDIR)\*.hlf"        > nul 2> nul
	-@del /q /f "$(OUTDIR)\*.lng"        > nul 2> nul
	-@del /q /f "$(OUTDIR)\File_id.diz"  > nul 2> nul
