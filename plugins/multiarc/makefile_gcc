OBJDIR = ./obj
REOBJDIR = \.\/obj\/
DLLDIR = ./final
NAME = MultiArc
DLLNAME = $(NAME).dll
DLLFULLNAME = $(DLLDIR)/$(DLLNAME)
SRCS = MultiArc.cpp \
arccfg.cpp \
arccmd.cpp \
arcget.cpp \
ArcMix.cpp \
ArcPlg.cpp \
ArcProc.cpp \
arcput.cpp \
arcread.cpp \
arcreg.cpp \
global.cpp
DEF = $(NAME).gcc.def

CXX = g++
DLLTOOL = dlltool
RM = rm -f
CP = cp -f
M4 = m4 -P
MV = mv -f
MKDIR = mkdir
WINDRES=windres
CXXFLAGS = -D_FAR_USE_FARFINDDATA -I ../common -Wall -Os -funsigned-char -fomit-frame-pointer -fno-rtti -fno-exceptions
LNKFLAGS = -mdll -s -nostartfiles -L ../common -lCRT

OBJS = $(patsubst %.cpp,$(OBJDIR)/%.o,$(filter %.cpp,$(SRCS))) $(OBJDIR)/$(NAME).res.o
DEPS = $(patsubst %.cpp,$(OBJDIR)/%.d,$(filter %.cpp,$(SRCS)))
MAP = $(patsubst %.dll,%.map,$(DLLFULLNAME))

all: crt $(DLLFULLNAME) fmt docs

crt:
	$(MAKE) -C ../common/CRT -f makefile_lib_gcc

$(OBJDIR)/%.d: %.cpp
	@echo making depends for $<
	@$(MKDIR) -p $(@D)
	@$(SHELL) -ec '$(CXX) -c -MM $(CXXFLAGS) $< \
                | sed '\''s/\($*\)\.o[ :]*/$(REOBJDIR)\1.o $(REOBJDIR)\1.d: /g'\'' > $@; [ -s $@ ] || $(RM) $@'

$(OBJDIR)/%.o: %.cpp
	@echo compiling $<
	@$(MKDIR) -p $(@D)
	@$(CXX) $(CXXFLAGS) -c -o $@ $<

$(OBJDIR)/$(NAME).res.o: $(NAME).rc ../common/farversion.hpp multiarcversion.hpp
	@$(MKDIR) -p $(@D)
	$(WINDRES) -i $< -o $@

$(DLLFULLNAME): $(OBJS) $(DEF)
	@echo linking $@
	@$(MKDIR) -p $(@D)
	@$(CXX) -mdll -o $(DLLNAME) -Xlinker --base-file -Xlinker $(DLLNAME).base $(OBJS) $(LNKFLAGS)
	@$(DLLTOOL) --dllname $(DLLNAME) --base-file $(DLLNAME).base --output-exp $(DLLNAME).exp --def $(DEF)
	@$(CXX) -mdll  -o $(DLLNAME) $(OBJS) $(DLLNAME).exp $(LNKFLAGS) -Xlinker -Map -Xlinker $(MAP)
	@$(MV) $(DLLNAME) $(DLLDIR)
	@$(RM) $(DLLNAME).base
	@$(RM) $(DLLNAME).exp

-include $(DEPS)

fmt:
	$(MAKE) -C ./libpcre -f makefile_lib_gcc
	$(MAKE) -f makefile_fmt_gcc FMT=Custom
	$(MAKE) -f makefile_fmt_gcc FMT=Ace
	$(MAKE) -f makefile_fmt_gcc FMT=Arc
	$(MAKE) -f makefile_fmt_gcc FMT=Arj
	$(MAKE) -f makefile_fmt_gcc FMT=Cab
	$(MAKE) -f makefile_fmt_gcc FMT=Ha
	$(MAKE) -f makefile_fmt_gcc FMT=Lzh
	$(MAKE) -f makefile_fmt_gcc FMT=Rar
	$(MAKE) -f makefile_fmt_gcc FMT=TarGz
	$(MAKE) -f makefile_fmt_gcc FMT=Zip
	$(CP) Custom.ini $(DLLDIR)/Formats

docs:
	$(CP) ArcEng.hlf $(DLLDIR)
	$(CP) ArcRus.hlf $(DLLDIR)
	$(CP) ArcEng.lng $(DLLDIR)
	$(CP) ArcRus.lng $(DLLDIR)
