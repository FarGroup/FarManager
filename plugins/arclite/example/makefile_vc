!include project.ini

ROOTDIR = ../../..

!include ../../makefile_vc_def_inc

TOOLSDIR = ..\tools

CPPFLAGS = $(CPPFLAGS) -DWIN32_LEAN_AND_MEAN -D_CRT_SECURE_CPP_OVERLOAD_STANDARD_NAMES=1

INCLUDES = -I.. -I..\7z\h
CPPFLAGS = $(CPPFLAGS) $(INCLUDES)
RFLAGS = $(RFLAGS) $(INCLUDES) $(DEFINES)

OBJS = $(OUTDIR)\module.obj
!if "$(BUILD_PLATFORM)" == "X86"
OBJS = $(OBJS) $(OUTDIR)\vc_crt_fix.obj $(OUTDIR)\vc_crt_fix_impl.obj
!endif

project: depfile
  $(MAKE) -nologo -f makefile_vc -$(MAKEFLAGS) build_project BUILD=1

build_project: $(OUTDIR)\$(MODULE).dll

$(OUTDIR)\$(MODULE).dll: $(OUTDIR)\module.def $(OBJS) $(OUTDIR)\headers.pch $(OUTDIR)\version.res project.ini
  link $(LINKFLAGS) -def:$(OUTDIR)\module.def -out:$@ $(OBJS) $(OUTDIR)\headers.obj $(OUTDIR)\version.res $(LINK_LIBS)

$(OBJS): $(OUTDIR)\headers.pch

.cpp{$(OUTDIR)}.obj::
  $(CPP) $(CPPFLAGS) -Yuheaders.hpp -FIheaders.hpp -Fp$(OUTDIR)\headers.pch $<

$(OUTDIR)\headers.pch: headers.cpp headers.hpp
  $(CPP) $(CPPFLAGS) headers.cpp -Ycheaders.hpp -Fp$(OUTDIR)\headers.pch

$(OUTDIR)\vc_crt_fix.obj: ..\..\common\vc_crt_fix.asm
  $(AS) $(AFLAGS) ..\..\common\vc_crt_fix.asm

$(OUTDIR)\vc_crt_fix_impl.obj: ..\..\common\vc_crt_fix_impl.cpp
  $(CPP) $(CPPFLAGS) $(FIXCRT_CPPFLAGS) ..\..\common\vc_crt_fix_impl.cpp

depfile: $(OUTDIR)
  $(TOOLSDIR)\tool gendep $(INCLUDES) > $(OUTDIR)\dep.mak

$(OUTDIR)\version.res: $(OUTDIR)\version.rc
  $(RC) $(RFLAGS) $**

PREPROC = $(TOOLSDIR)\tool preproc $** $@

$(OUTDIR)\version.rc: project.ini version.rc
  $(PREPROC)

$(OUTDIR)\module.def: project.ini module.def
  $(PREPROC)

COPY = copy /y $** $@

$(OUTDIR):
  if not exist $(OUTDIR) mkdir $(OUTDIR)

!ifdef BUILD
!include $(OUTDIR)\dep.mak
!endif


clean:
  if exist $(OUTDIR) rd /s /q $(OUTDIR)


.PHONY: project build_project depfile clean
