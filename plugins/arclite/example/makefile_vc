!include project.ini

ROOTDIR = ../../..

!include ../../makefile_vc_def_inc

TOOLSDIR = ..\tools

INCLUDES = -I.. -I..\7z\h
CPPFLAGS = $(CPPFLAGS) $(INCLUDES)
RFLAGS = $(RFLAGS) $(INCLUDES) $(DEFINES)

OBJS = $(INTDIR)\module.obj
!if "$(BUILD_PLATFORM)" == "X86"
OBJS = $(OBJS) $(INTDIR)\vc_crt_fix.obj $(INTDIR)\vc_crt_fix_impl.obj
!endif

project: depfile
  $(MAKE) -nologo -f makefile_vc -$(MAKEFLAGS) build_project BUILD=1

build_project: $(OUTDIR)\$(NAME).dll

$(OUTDIR)\$(NAME).dll: $(INTDIR)\module.def $(OBJS) $(INTDIR)\headers.pch $(INTDIR)\version.res project.ini
  link $(LINKFLAGS) -def:$(INTDIR)\module.def -out:$@ $(OBJS) $(INTDIR)\headers.obj $(INTDIR)\version.res $(LINK_LIBS)

$(OBJS): $(INTDIR)\headers.pch

.cpp{$(INTDIR)}.obj::
  $(CPP) $(CPPFLAGS) -Yuheaders.hpp -FIheaders.hpp -Fp$(INTDIR)\headers.pch $<

$(INTDIR)\headers.pch: headers.cpp headers.hpp
  $(CPP) $(CPPFLAGS) headers.cpp -Ycheaders.hpp -Fp$(INTDIR)\headers.pch

$(INTDIR)\vc_crt_fix.obj: ..\..\common\vc_crt_fix.asm
  $(AS) $(AFLAGS) ..\..\common\vc_crt_fix.asm

$(INTDIR)\vc_crt_fix_impl.obj: ..\..\common\vc_crt_fix_impl.cpp
  $(CPP) $(CPPFLAGS) $(FIXCRT_CPPFLAGS) ..\..\common\vc_crt_fix_impl.cpp

depfile: $(INTDIR)
  $(TOOLSDIR)\tool gendep $(INCLUDES) > $(INTDIR)\dep.mak

$(INTDIR)\version.res: $(INTDIR)\version.rc
  $(RC) $(RFLAGS) $**

PREPROC = $(TOOLSDIR)\tool preproc $** $@

$(INTDIR)\version.rc: project.ini version.rc
  $(PREPROC)

$(INTDIR)\module.def: project.ini module.def
  $(PREPROC)

COPY = copy /y $** $@

$(OUTDIR):
  if not exist $(OUTDIR) mkdir $(OUTDIR)

$(INTDIR):
  if not exist $(INTDIR) mkdir $(INTDIR)

!ifdef BUILD
!include $(INTDIR)\dep.mak
!endif


clean:
  if exist $(OUTDIR) rd /s /q $(OUTDIR)


.PHONY: project build_project depfile clean
